#!/usr/bin/env ruby

$: << File.dirname(__FILE__)+'/lib'

require 'campfire'

notifier = Campfire.room ENV['CF_ROOM']
i=0
loop do
  total, available, unconfirmed, contacts = 0, 0, 0, 0
  `heroku rake floods:report:listings --app ozfloodhelp`.each_line do |line|
    total = $1.to_i if line =~ /Total listings:\t\t(\d+)/
    available = $1.to_i if line =~ /Available listings:\t(\d+)/
    unconfirmed = $1.to_i if line =~ /Unconfirmed listings:\t(\d+)/
    contacts = $1.to_i if line =~ /Total contacts:\t\t(\d+)/
  end
  unavailable = total - (available+unconfirmed)
  if i%20 == 0 
    i = 0
    notifier.message <<EOF
#{total} listings:
  #{unconfirmed} inactive (#{unconfirmed*100/total}%)
  #{available} available (#{available*100/total})
  #{unavailable} unavailable (#{unavailable*100/total})
#{contacts} contacts
EOF
  end
  puts "#{Time.new.to_i},#{unconfirmed},#{available},#{unavailable},#{contacts}"
  sleep 60
  i += 1
end